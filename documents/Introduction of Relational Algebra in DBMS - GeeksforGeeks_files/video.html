<!DOCTYPE html>
<!-- saved from url=(0048)https://aa.geeksforgeeks.org/instream/video.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><style class="vjs-styles-defaults">
      .video-js {
        width: 300px;
        height: 150px;
      }

      .vjs-fluid {
        padding-top: 56.25%
      }
    </style>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="./video-js.css" rel="stylesheet">
    <script type="text/javascript" id="www-widgetapi-script" src="./www-widgetapi.js.download" async=""></script><script src="./iframe_api"></script><script src="./video.min.js.download"></script>
    <script src="./videojs-http-source-selector.min.js.download"></script>
    <script src="./videojs-contrib-quality-levels.min.js.download"></script>
    <script src="./Youtube.min.js.download"></script><style type="text/css">.vjs-youtube .vjs-iframe-blocker { display: none; }.vjs-youtube.vjs-user-inactive .vjs-iframe-blocker { display: block; }.vjs-youtube .vjs-poster { background-size: cover; }.vjs-youtube-mobile .vjs-big-play-button { display: none; }</style>
    <style>
        html {
            overflow: hidden;
        }

        .vjs-big-play-button {
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
        }

        .video-js .vjs-tech {
            object-fit: contain;
            /* Ensure the video fills the player area */
            width: 100%;
            height: 100%;
        }

        .intro {
            width: 100%;
            position: relative;
        }

        .popout-video {
            width: 100%;
            position: relative;
            display: flex;
            justify-content: center;
            min-height: 360px;
            margin: 20px 0;
        }

        .popout-video--popout {
            position: fixed;
            left: 0;
            bottom: 0 !important;
            animation: shimmy 0.2s ease;
        }

        .popout-video--popout>.video-js,
        .popout-video--popout>video {
            width: 300px !important;
            height: 170px !important;
        }

        .popout-video--popout.popout-video {
            display: block !important;
        }

        .bg-video-placeholder {
            max-width: 640px;
            height: 360px;
            background-color: rgba(0, 0, 0, .78);
            margin: auto;
        }

        @keyframes shimmy {
            0% {
                transform: translate(0, 300px);
            }

            25% {
                transform: translate(0, 200px);
            }

            50% {
                transform: translate(0, 100px);
            }

            75% {
                transform: translate(0, 50px);
            }

            100% {
                transform: translate(0, 0);
            }
        }

        .popout-video video {
            width: 100%;
            vertical-align: middle;
        }

        .content_video-dimensions {
            width: 640px !important;
            height: 360px !important;
        }

        .vjs-menu li.vjs-menu-item {
            margin: 0 !important;
            text-align: center !important;
        }

        .vjs-menu li.vjs-menu-item.vjs-selected {
            color: #2b333f !important;
        }

        .video_course_url a {
            background: var(--faded-green) 0% 0% no-repeat padding-box;
            padding: 10px 16px;
            opacity: 1;
            border: 1px solid var(--faded-green);
            max-width: 640px;
            display: block;
            margin: 20px auto;
            text-align: center;
            border-radius: 5px;
        }

        @media (max-width:600px) {
            .content_video-dimensions {
                width: 100% !important;
                height: auto !important;
                min-height: 200px;
            }
        }

        #default_button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 12px;
            padding: 6px 32px;
            background-color: #676f76;
        }

        #video-overlay {
            transition: opacity 0.3s ease;
        }

        #play-pause-button {
            transition: transform 0.2s ease;
        }

        #play-pause-button:hover {
            transform: scale(1.1);
        }
    </style>
    <title>Instream Video Player</title>
</head>

<body>
    <div id="video-container">
        <!-- Video content will be injected here -->
    </div>
    <script>
        // Declaring global variables
        let player; // VideoJS player instance
        let imaOptions;
        let currentVideoIndex = 0;
        let playlist = [];
        var youtubeVideo;
        var youtubeVideoPlayInIndia;
        let autoplayPlaylistEnabled = true; // Set this to false to disable autoplaye the next video in playlist
        let adsEnabled = false; // Set this to false to disable ads

        function loadAdScripts() {
            const scriptsToLoad = [
                "https://imasdk.googleapis.com/js/sdkloader/ima3.js",
                "https://cdn.jsdelivr.net/npm/videojs-contrib-ads@6.9.0/dist/videojs.ads.min.js",
                "https://cdn.jsdelivr.net/npm/videojs-ima@1.6.0/dist/videojs.ima.js"
            ];

            scriptsToLoad.forEach(scriptUrl => {
                const script = document.createElement('script');
                script.src = scriptUrl;
                script.async = true;
                document.head.appendChild(script);
            });
        }

        function initializePage() {
            if (adsEnabled) {
                loadAdScripts();
            }

            document.addEventListener('DOMContentLoaded', function () {
                window.addEventListener("message", (event) => {
                    if (event.data.resp) {
                        playlist = event.data.resp;
                        getVideoContent(event.data.resp);
                    }

                    // Changing the currentVideoIndex when click on the video from playlist
                    if (event.data.clickedVideoFromPlaylist && typeof (event.data.currentIndex) !== 'undefined' && event.data.currentIndex >= 0) {
                        currentVideoIndex = event.data.currentIndex;
                    }

                    if (event.data.playlist) {
                        if (player) {
                            player.dispose(); // To destroy the old player instance
                        }
                        const videoContainer = document.getElementById('video-container');
                        if (videoContainer) {
                            videoContainer.innerHTML = ''; // Clear the old player to load new one
                        }
                        getVideoContent(event.data.playlist);
                    }
                });
            });
        }

        // Call the function to initialize the page
        initializePage();

        // ************************************** //
        // ************* FUNCTIONS ************** //
        // ************************************** //

        // Video URLS
        let GFG_VIDEO_URL = 'https://videos.geeksforgeeks.org/hls/51f1b63616e160911804b2f79ded5f44gfg-MergeSortGeeksforGeeks20220610170254.m3u8'
        let GFG_VIDEO_TYPE = 'application/x-mpegURL'
        let YOUTUBE_VIDEO_TYPE = 'video/youtube';
        let SAMPLE_VIDEO_URL = 'https://storage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4'
        let SAMPLE_VIDEO_TYPE = 'video/mp4'
        let VMAP_URL_LIVE = 'https://aa.geeksforgeeks.org/instream/vast.xml';

        function getVideoContent(resp) {
            if (resp.length > 0) {
                resp = resp[0];
                if (resp.duration && resp.duration < 180) { // 180 seconds
                    VMAP_URL_LIVE = 'https://aa.geeksforgeeks.org/instream/vast2.xml';
                }

                youtubeVideo = isYoutubeVideo(resp);
                youtubeVideoPlayInIndia = canPlayInIndia(resp);

                const largeThumbnail = resp?.meta?.largeThumbnail || "https://media.geeksforgeeks.org/wp-content/cdn-uploads/20220715141141/default-large-video-thumbnail.png";
                const SUBTITLE_URL = resp?.subtitle

                // Get the Video Container
                const videoContainer = document.getElementById('video-container');
                videoContainer.style.display = 'flex';
                videoContainer.style.justifyContent = 'center';

                // Create the video element 
                let videoElement = document.createElement('video');
                videoElement.id = 'my-video';
                videoElement.className = 'video-js vjs-default-skin';
                videoElement.setAttribute('controls', 'controls');
                videoElement.setAttribute('preload', 'auto');
                videoElement.setAttribute('width', '640px');
                videoElement.setAttribute('height', '360px');
                // videoElement.setAttribute('muted', 'muted'); // This will make sure the video is initial muted

                // Add the subtitle track
                if (SUBTITLE_URL && !youtubeVideo) {
                    let trackElement = document.createElement('track');
                    trackElement.setAttribute('kind', 'subtitles');
                    trackElement.setAttribute('src', SUBTITLE_URL);
                    trackElement.setAttribute('srclang', 'en');
                    trackElement.setAttribute('label', 'English');
                    trackElement.setAttribute('default', 'default');

                    // Append the track to the video element
                    videoElement.appendChild(trackElement);
                }

                // Insert the videoElement into the "video-container" div
                videoContainer.appendChild(videoElement);

                // Initialize the video player
                if (typeof window.videojs !== 'undefined') {
                    // Changing video option based on Youtube and non-Youtube video
                    let video_options = (youtubeVideo && youtubeVideoPlayInIndia) ? {
                        techOrder: ['youtube', 'html5'],
                        sources: [{
                            src: resp.source,
                            type: YOUTUBE_VIDEO_TYPE
                        }],
                        // autoplay: true
                    } : {
                        techOrder: ['html5'],
                        sources: [{
                            src: resp.source,
                            type: GFG_VIDEO_TYPE
                        }],
                        playbackRates: [0.5, 1, 1.25, 1.5, 2],
                        poster: largeThumbnail, // Set the poster image
                        // autoplay: true,
                    }
                    player = videojs(videoElement, video_options);

                    if (adsEnabled && !youtubeVideo) {
                        imaOptions = {
                            adTagUrl: VMAP_URL_LIVE
                        };

                        player.ima(imaOptions);
                    }

                    player.ready(function () {
                        console.log('Player is ready');
                    });

                    player.on('play', () => {
                        if(!youtubeVideo){
                            handleVideoView(resp);
                        }
                    });

                    player.on('error', function () {
                        console.error('VideoJS Error:', player.error());
                    });

                    player.on('ended', function () {
                        currentVideoIndex++;
                        if (autoplayPlaylistEnabled && currentVideoIndex < playlist.length) {
                            loadNextVideo(playlist[currentVideoIndex], currentVideoIndex);
                        }
                    });

                    if (!youtubeVideo) {
                        // Ensure the menu is updated with available quality levels
                        player.qualityLevels().on('addqualitylevel', function () {
                            player.httpSourceSelector();
                        });
                    }
                } else {
                    console.error("videojs is not defined in iframe");
                }
            }
        }

        function isYoutubeVideo(resp) {
            if (resp?.external_youtube && resp?.source) {
                try {
                    const url = new URL(resp.source);
                    const domain = url.hostname;

                    if (domain.includes("geeksforgeeks.org")) {
                        return false;
                    }
                    return true;
                } catch (error) {
                    console.error("Invalid Video URL:", resp.source);
                    return false; // Return false for invalid URLs
                }
            }
            return false;
        }

        function canPlayInIndia(resp) {
            if (resp?.visibility === 'india' || resp?.visibility === 'both') {
                return true;
            }
            return false;
        }

        function loadNextVideo(videoData, currentVideoIndex) {
            if (player) {
                player.dispose();
            }
            const videoContainer = document.getElementById('video-container');
            if (videoContainer) {
                videoContainer.innerHTML = '';
            }

            window.parent.postMessage({
                type: 'AUTOPLAYED_NEXT_VIDEO',
                autoplayPlaylistEnabled: autoplayPlaylistEnabled,
                videoData: videoData,
                currentVideoIndex: currentVideoIndex
            }, '*');

            getVideoContent([videoData]);
        }

        const handleVideoView = async (resp) => {
            try {
                const slug = resp?.slug;
                const csrfToken = await fetchCSRFToken();
                await updateVideoView(slug, csrfToken);
            } catch (error) {
                console.error('Error updating handling video view:', error);
            }
        }

        const fetchCSRFToken = async () => {
            try {
                const response = await fetch('https://apiscript.geeksforgeeks.org/get-csrf-token/', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const csrfToken = getCookie('csrftoken');
                    if (csrfToken) {
                        return csrfToken;
                    } else {
                        throw new Error('CSRF token not found in cookies');
                    }
                } else {
                    throw new Error('Failed to fetch CSRF token');
                }
            } catch (error) {
                throw new Error(`Error while fetching CSRF token: ${error.message}`);
            }
        }

        const updateVideoView = async (slug, csrfToken) => {
            const payload = { slug: slug };
            try {
                const response = await fetch('https://apiscript.geeksforgeeks.org/update-user-views/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                })

                if (response.ok) {
                    let successData = await response.json();
                    console.log(successData);
                } else {
                    const errorData = await response.json();
                    console.error('Failed to update video views:', errorData);
                }
            } catch (error) {
                console.error('Error while updating video views:', error);
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>



</body></html>